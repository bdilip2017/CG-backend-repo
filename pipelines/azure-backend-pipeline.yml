# azure-pipelines-backend.yml
trigger:
  branches:
    include:
      - main

stages:
  - stage: Build
    jobs:
      - job: BuildBackend
        displayName: "Build Backend"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: UseJava@1
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'

          - script: |
              chmod +x mvnw
              ./mvnw clean package -DskipTests
            displayName: 'Build Spring Boot Application'

          - task: Docker@2
            inputs:
              command: 'buildAndPush'
              repository: '$(containerRegistry)/backend-app'
              Dockerfile: '**/Dockerfile'
              tags: '$(Build.BuildId)'
              containerRegistry: '$(containerRegistryServiceConnection)'

  - stage: Deploy
    dependsOn: Build
    jobs:
      - deployment: DeployToDev
        displayName: "Deploy Backend to Dev"
        environment: 'dev'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: Kubernetes@1
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: '$(azureSubscription)'
                    azureResourceGroup: '$(aksResourceGroup)'
                    kubernetesCluster: '$(aksClusterNameDev)'
                    namespace: 'dev'
                    command: 'apply'
                    useConfigurationFile: true
                    configurationFile: 'k8s/backend-deployment.yaml'
        variables:
          - name: containerRegistry
            value: 'youracrname.azurecr.io'  # Dev ACR
          - name: aksClusterNameDev
            value: 'aks-cluster-dev'

      - deployment: DeployToStaging
        displayName: "Deploy Backend to Staging"
        environment: 'staging'
        dependsOn: DeployToDev
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: Kubernetes@1
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: '$(azureSubscription)'
                    azureResourceGroup: '$(aksResourceGroup)'
                    kubernetesCluster: '$(aksClusterNameStaging)'
                    namespace: 'staging'
                    command: 'apply'
                    useConfigurationFile: true
                    configurationFile: 'k8s/backend-deployment.yaml'
        variables:
          - name: containerRegistry
            value: 'youracrname.azurecr.io'  # Staging ACR
          - name: aksClusterNameStaging
            value: 'aks-cluster-staging'

      - deployment: DeployToProd
        displayName: "Deploy Backend to Production"
        environment: 'prod'
        dependsOn: DeployToStaging
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            preDeploy:
              - task: ManualValidation@0
                inputs:
                  instructions: 'Approve to proceed with Production deployment.'
                  onTimeout: 'reject'  # Rejects if not approved within the timeout
                  timeout: '300'        # 30 minutes for approval
            deploy:
              steps:
                - task: Kubernetes@1
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscription: '$(azureSubscription)'
                    azureResourceGroup: '$(aksResourceGroup)'
                    kubernetesCluster: '$(aksClusterNameProd)'
                    namespace: 'prod'
                    command: 'apply'
                    useConfigurationFile: true
                    configurationFile: 'k8s/backend-deployment.yaml'
        variables:
          - name: containerRegistry
            value: 'acrname.azurecr.io'  # Prod ACR
          - name: aksClusterNameProd
            value: 'aks-cluster-prod'
